<!-- Brutalist Chat Interface -->
<div style="height: 100vh; display: flex; flex-direction: column; min-height: 0;">
  <!-- Chat Area -->
  <div
    style="flex: 1; display: flex; flex-direction: column; padding: calc(var(--space-unit) * 2) var(--space-unit) var(--space-unit); overflow: hidden; min-height: 0;">

    <!-- Welcome State -->
    @if (messages().length === 0) {
      <div class="search-welcome-container" style="
        display: flex;
        flex-direction: column;
        align-items: center;
        flex: 1;
        text-align: center;
        gap: calc(var(--space-unit) * 2);
        margin: 0 auto;
        width: 100%;
      ">

        <!-- Suggestion Buttons -->
        <div class="search-suggestions" style="
          display: grid;
          grid-template-columns: 1fr;
          gap: calc(var(--space-unit) * 1.5);
          width: 100%;
          max-width: 45rem;
        ">
          @for (suggestion of suggestions; track suggestion) {
            <button
              (click)="useSuggestion(suggestion)"
              style="
              border: var(--border-width) solid rgb(var(--color-accent));
              background: transparent;
              color: rgb(var(--color-accent));
              padding: calc(var(--space-unit) * 1.25) var(--space-unit);
              font-family: var(--font-mono);
              text-align: left;
              cursor: pointer;
              text-transform: lowercase;
              transition: all 0.2s ease;
            "
              onmouseover="this.style.background='rgb(var(--color-accent))'; this.style.color='rgb(var(--color-bg))'"
              onmouseout="this.style.background='transparent'; this.style.color='rgb(var(--color-accent))'">
              <div style="display: flex; align-items: center; gap: 0.75rem;">
              <span style="
                display: inline-block;
                width: 1.5rem;
                height: 1.5rem;
                background: rgb(var(--color-accent));
                color: rgb(var(--color-bg));
                text-align: center;
                line-height: 1.5rem;
                font-size: 1.2rem;
                flex-shrink: 0;
              ">⚡</span>
                <span style="line-height: 1.4;">{{ suggestion }}</span>
              </div>
            </button>
          }
        </div>
      </div>
    }

    <!-- Chat Messages -->
    @else {
      <div
        class="search-chat-container"
        #messagesContainer
        (scroll)="onScroll()"
        style="
          flex: 1;
          overflow-y: auto;
          margin-bottom: calc(var(--space-unit) * 1.5);
          border: var(--border-width) solid rgb(var(--color-text-muted));
          padding: calc(var(--space-unit) * 1.5) var(--space-unit);
        ">
        @for (message of messages(); track message.id) {
          <div style="margin-bottom: var(--space-unit); display: flex;"
               [style.justify-content]="message.role === 'user' ? 'flex-end' : 'flex-start'">

            <!-- User Message -->
            @if (message.role === 'user') {
              <div style="
                max-width: 70%;
                border: var(--border-width) solid rgb(var(--color-accent));
                background: rgb(var(--color-accent));
                color: rgb(var(--color-bg));
                padding: var(--space-unit);
                font-family: var(--font-mono);
              ">
                <div style="white-space: pre-wrap;">{{ message.content }}</div>
                <div style="
                  font-size: 0.8rem;
                  margin-top: 0.5rem;
                  opacity: 0.7;
                ">{{ formatTimestamp(message.timestamp) }}
                </div>
              </div>
            }

            <!-- Assistant Message -->
            @else {
              <div style="
                max-width: 70%;
                border: var(--border-width) solid rgb(var(--color-text-muted));
                background: transparent;
                color: rgb(var(--color-text));
                padding: var(--space-unit);
                font-family: var(--font-mono);
              ">
                @if (isMessageStreaming(message)) {
                  <div style="display: flex; gap: 0.25rem; margin-bottom: 0.5rem;">
                    <span style="animation: bounce 1s infinite 0s;">•</span>
                    <span style="animation: bounce 1s infinite 0.1s;">•</span>
                    <span style="animation: bounce 1s infinite 0.2s;">•</span>
                  </div>
                }

                @if (message.content) {
                  <div style="white-space: pre-wrap; line-height: 1.4;">{{ message.content }}</div>

                  @if (!isMessageStreaming(message)) {
                    <div style="
                      display: flex;
                      justify-content: space-between;
                      align-items: center;
                      margin-top: var(--space-unit);
                      padding-top: var(--space-unit);
                      border-top: var(--border-width) solid rgb(var(--color-text-muted));
                      font-size: 0.8rem;
                    ">
                      <span>{{ formatTimestamp(message.timestamp) }}</span>
                      <button
                        (click)="copyMessage(message)"
                        style="
                          background: transparent;
                          border: var(--border-width) solid rgb(var(--color-text-muted));
                          color: rgb(var(--color-text-muted));
                          padding: 0.25rem 0.5rem;
                          font-family: var(--font-mono);
                          font-size: 0.8rem;
                          cursor: pointer;
                        "
                        onmouseover="this.style.background='rgb(var(--color-text-muted))'; this.style.color='rgb(var(--color-bg))'"
                        onmouseout="this.style.background='transparent'; this.style.color='rgb(var(--color-text-muted))'">
                        copy
                      </button>
                    </div>
                  }
                }
              </div>
            }
          </div>
        }
      </div>
    }
  </div>

  <!-- Input Area - Fixed at bottom -->
  <div class="search-input-container" style="
    position: sticky;
    bottom: 0;
    background: rgb(var(--color-bg));
    padding: calc(var(--space-unit) * 1.25) var(--space-unit);
    border-top: var(--border-width) solid rgb(var(--color-text-muted));
  ">
    <div style="margin: 0 auto;">
      <form (ngSubmit)="sendMessage()" style="display: flex; gap: var(--space-unit);">
        <textarea
          #messageInput
          (compositionend)="handleCompositionEnd()"
          (compositionstart)="handleCompositionStart()"
          (keydown)="handleKeyDown($event)"
          [(ngModel)]="currentMessage"
          [disabled]="!canSendMessage() || isComposing()"
          name="message"
          placeholder="What do you want to know about?"
          rows="1"
          style="
            flex: 1;
            border: var(--border-width) solid rgb(var(--color-text-muted));
            background: transparent;
            color: rgb(var(--color-text));
            padding: calc(var(--space-unit) * 1.125) var(--space-unit);
            font-family: var(--font-mono);
            resize: none;
            min-height: 3.5rem;
            max-height: 8rem;
            font-size: 1rem;
            line-height: 1.4;
          "></textarea>

        <button
          [disabled]="!canSendMessage() || !currentMessage().trim() || isComposing()"
          onmouseout="if(!this.disabled) { this.style.background='rgb(var(--color-accent))'; this.style.color='rgb(var(--color-bg))' }"
          onmouseover="if(!this.disabled) { this.style.background='transparent'; this.style.color='rgb(var(--color-accent))' }"
          style="
            border: var(--border-width) solid rgb(var(--color-accent));
            background: rgb(var(--color-accent));
            color: rgb(var(--color-bg));
            padding: calc(var(--space-unit) * 1.125) var(--space-unit);
            font-family: var(--font-mono);
            cursor: pointer;
            text-transform: lowercase;
            width: 4.5rem;
            min-height: 3.5rem;
            font-size: 1.1rem;
          "
          type="submit">
          @if (isStreaming()) {
            ⏹
          } @else {
            ↗
          }
        </button>
      </form>
    </div>

    <!-- Controls and Error Display -->
    @if (messages().length > 0) {
      <div style="
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-top: var(--space-unit);
        border-top: var(--border-width) solid rgb(var(--color-text-muted));
        margin-top: var(--space-unit);
        font-size: 0.8rem;
      ">
        <div style="display: flex; gap: var(--space-unit);">
          <button
            (click)="clearChat()"
            style="
              background: transparent;
              border: var(--border-width) solid rgb(var(--color-text-muted));
              color: rgb(var(--color-text-muted));
              padding: 0.25rem 0.5rem;
              font-family: var(--font-mono);
              font-size: 0.8rem;
              cursor: pointer;
            "
            onmouseover="this.style.background='rgb(var(--color-text-muted))'; this.style.color='rgb(var(--color-bg))'"
            onmouseout="this.style.background='transparent'; this.style.color='rgb(var(--color-text-muted))'">
            clear
          </button>

          @if (isStreaming()) {
            <button
              (click)="cancelStream()"
              style="
              background: transparent;
              border: var(--border-width) solid rgb(var(--color-accent));
              color: rgb(var(--color-accent));
              padding: 0.25rem 0.5rem;
              font-family: var(--font-mono);
              font-size: 0.8rem;
              cursor: pointer;
            "
              onmouseover="this.style.background='rgb(var(--color-accent))'; this.style.color='rgb(var(--color-bg))'"
              onmouseout="this.style.background='transparent'; this.style.color='rgb(var(--color-accent))'">
              stop
            </button>
          }
        </div>

        <div style="
          color: rgb(var(--color-text-muted));
          font-family: var(--font-mono);
          font-size: 0.8rem;
        ">
          {{ messages().length }} message{{ messages().length !== 1 ? "s" : "" }}
        </div>
      </div>
    }

    <!-- Error Display -->
    @if (chatError()) {
      <div style="
      margin-top: var(--space-unit);
      border: var(--border-width) solid rgb(var(--color-accent));
      background: transparent;
      color: rgb(var(--color-accent));
      padding: var(--space-unit);
      font-family: var(--font-mono);
    ">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <span>error: {{ chatError() }}</span>
          <button
            (click)="retryLastMessage()"
            style="
            background: transparent;
            border: var(--border-width) solid rgb(var(--color-accent));
            color: rgb(var(--color-accent));
            padding: 0.25rem 0.5rem;
            font-family: var(--font-mono);
            font-size: 0.8rem;
            cursor: pointer;
          "
            onmouseover="this.style.background='rgb(var(--color-accent))'; this.style.color='rgb(var(--color-bg))'"
            onmouseout="this.style.background='transparent'; this.style.color='rgb(var(--color-accent))'">
            retry
          </button>
        </div>
      </div>
    }
  </div>
</div>

<!-- Brutalist scrollbar and input styles -->
<style>
  @keyframes bounce {
    0%, 20%, 50%, 80%, 100% {
      transform: translateY(0);
    }
    40% {
      transform: translateY(-0.5rem);
    }
    60% {
      transform: translateY(-0.25rem);
    }
  }

  textarea:focus {
    outline: var(--border-width) solid rgb(var(--color-accent));
  }

  button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  button:disabled:hover {
    background: rgb(var(--color-text-muted)) !important;
    color: rgb(var(--color-bg)) !important;
  }

  /* Mobile-specific improvements */
  @media (max-width: 768px) {
    .search-welcome-container {
      padding: calc(var(--space-unit) * 1.5) !important;
      gap: calc(var(--space-unit) * 1.5) !important;
    }

    .search-welcome-header h1 {
      font-size: 1.5rem !important;
    }

    .search-welcome-header .search-icon {
      width: 3rem !important;
      height: 3rem !important;
      font-size: 1.25rem !important;
    }

    .search-suggestions {
      gap: var(--space-unit) !important;
    }

    .search-suggestions button {
      padding: var(--space-unit) calc(var(--space-unit) * 0.75) !important;
      font-size: 0.9rem !important;
    }

    .search-input-container {
      padding: var(--space-unit) calc(var(--space-unit) * 0.75) !important;
    }

    .search-input-container textarea {
      min-height: 3rem !important;
      padding: var(--space-unit) calc(var(--space-unit) * 0.75) !important;
      font-size: 0.9rem !important;
    }

    .search-input-container button {
      width: 3.5rem !important;
      min-height: 3rem !important;
      padding: var(--space-unit) calc(var(--space-unit) * 0.75) !important;
      font-size: 1rem !important;
    }

    .search-chat-container {
      padding: var(--space-unit) calc(var(--space-unit) * 0.75) !important;
    }
  }

  @media (max-width: 480px) {
    .search-welcome-header h1 {
      font-size: 1.25rem !important;
    }

    .search-welcome-header p {
      font-size: 0.85rem !important;
    }

    .search-suggestions button {
      font-size: 0.85rem !important;
    }
  }
</style>
